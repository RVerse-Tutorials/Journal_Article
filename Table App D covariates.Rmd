---
title: "Influential Years Analysis"
output:
  pdf_document: default
  word_document: default
header-includes: \usepackage[labelformat=empty]{caption}
---

```{r child = 'setup.Rmd'}
```

```{r funs, echo=FALSE}
  ret <- function(mod, resfun){
    if(resfun=="aic") return(mod$aic)
    if(resfun=="loo") return(SardineForecast:::loogam(mod)$RMSE)
    if(resfun=="r2") return(summary(mod)$r.sq)
  }
rmyr <- c(1987)
```

## Validation of the Jul-Sep landings base models

To evaluate the base model for the Jul-Sep landings using only prior catch as covariates, GAM and linear models with Jul-Sep and Oct-Mar in the prior season and two seasons prior as covariates were fit to the 1984-2015 landings. The models were fit leaving one year out (year shown on the x-axis). The far right shows the fit to all years. 

In Figure 1D, the $\Delta$AIC values are the AIC minus the AIC of the best model (model with lowest AIC). Models with $\Delta$AIC with 0.5 are similar and "best". Models within 2 of the best models are competitive. Models with $\Delta$AIC greater than 2 are uncompetitive.

The Figure 1D shows that with an year left out the set of models that is best was always GAM with Oct-Mar and Jul-Sep landings in the prior season, GAM with Oct-Mar landings in the prior season, or a linear model with Oct-Mar landings in the prior season. There were cases where deleting a year removed one of these three from the 'best' category, but they were still in the 'competitive category.

```{r table-appD-spawner-cov, echo=FALSE}
spawnerinfcov <- function(rmyr=1900, resfun="aic", mod=2){
covnames=c(
           "precip.gpcp.kerala.mon6to7.0", "precip.gpcp.kerala.mon4to5.0",
           "precip.gpcp.kerala.mon6to7.1", "precip.gpcp.kerala.mon4to5.1",
           "SST.UPW.4.mon6to9.0", "SST.2.10.mon6to9.0", "Bakun.UPW.mon6to9.0",
           "SST.UPW.4.mon6to9.1", "SST.2.10.mon6to9.1", "Bakun.UPW.mon6to9.1",
           "SST.2.10.mon3to5.0", "SST.2.10.mon3to5.1",
           "SST.2.10.mon10to12.1",
           "SST.2.10.3.yr.runsum.0",
           "ONI.mon1to12.0", "DMI.mon9to11.0",
           "ONI.mon1to12.1", "DMI.mon9to11.1")
modnames=c(
           "Precip Jun-Jul(t)", "Precip Apr-May(t)",
           "Precip Jun-Jul(t-1)", "Precip Apr-May(t-1)",
           "SST-UPW Jun-Sep(t)", "SST Jun-Sep(t)", "Bakun-UPW Jun-Sep(t)",
           "SST-UPW Jun-Sep(t-1)", "SST Jun-Sep(t-1)", "Bakun-UPW Jun-Sep(t-1)",
           "SST Mar-May(t)", "SST Mar-May(t-1)",
           "SST Oct-Dec(t-1)",
           "2.5 yr ave SST",
           "ONI(t)", "DMI Sep-Nov(t)",
           "ONI(t-1)", "DMI Sep-Nov(t-1)")

## SPAWNERS
dat=dat.spawners
dat$spawners0[dat$Year%in%rmyr]=NA

if(mod==2) m0 = gam(spawners0 ~ s(nspawners1, sp=0.6) + s(spawners1, sp=0.6), data=dat)
if(mod==1) m0 = gam(spawners0 ~ s(nspawners1, sp=0.6), data=dat)
res = data.frame(model="base)", None=ret(m0, resfun))
for(i in 1:length(covnames)){
  cov <- covnames[i]
  dat$cov=dat[[cov]]
  if(mod==2) m0 = gam(spawners0 ~ s(nspawners1, sp=0.6) + s(spawners1, sp=0.6) + cov, data=dat)
  if(mod==1) m0 = gam(spawners0 ~ s(nspawners1, sp=0.6) + cov, data=dat)
  tmp = data.frame(model=paste0("lin(", modnames[i], ")"), None=ret(m0, resfun))
  res = rbind(res, tmp)
  if(mod==2) m0 = gam(spawners0 ~  s(nspawners1, sp=0.6) + s(spawners1, sp=0.6) + s(cov, sp=0.6), data=dat)
  if(mod==1) m0 = gam(spawners0 ~  s(nspawners1, sp=0.6) + s(cov, sp=0.6), data=dat)
  tmp = data.frame(model=paste0("gam(", modnames[i], ")"), None=ret(m0, resfun))
  res = rbind(res, tmp)
}

for(yr in 1984:2014){
  bad = yr
  dat2=dat
  dat2$spawners0[dat$Year%in%bad]=NA
  #dat2$nspawners1[dat$Year%in%(bad+1)]=NA
  if(mod==2) m0 = gam(spawners0 ~ s(nspawners1, sp=0.6) + s(spawners1, sp=0.6), data=dat2)
  if(mod==1) m0 = gam(spawners0 ~ s(nspawners1, sp=0.6), data=dat2)
  tmpres = data.frame(model="base: lin(Oct-Mar landings t-1)",None=ret(m0, resfun))

for(i in 1:length(covnames)){
  cov <- covnames[i]
  dat2$cov=dat2[[cov]]
  if(mod==2) m0 = gam(spawners0 ~ s(nspawners1, sp=0.6) + s(spawners1, sp=0.6) + cov, data=dat2)
  if(mod==1) m0 = gam(spawners0 ~ s(nspawners1, sp=0.6) + cov, data=dat2)
  tmp = data.frame(model=paste0("lin(", modnames[i], ")"), None=ret(m0, resfun))
  tmpres = rbind(tmpres, tmp)
  if(mod==2) m0 = gam(spawners0 ~ s(nspawners1, sp=0.6) + s(spawners1, sp=0.6) + s(cov, sp=0.6), data=dat2)
  if(mod==1) m0 = gam(spawners0 ~ s(nspawners1, sp=0.6) + s(cov, sp=0.6), data=dat2)
  tmp = data.frame(model=paste0("gam(", modnames[i], ")"), None=ret(m0, resfun))
  tmpres = rbind(tmpres, tmp)
}
  colnames(tmpres)=c("model", yr)
  res=cbind(res,tmpres[,2,drop=FALSE])
}

return(res)
}

```

```{r plot-spawners-cov, echo=FALSE,fig.cap="Figure 1D. Delta AIC for the Jul-Sep landings base models with one year deleted. Deleted year is shown on the x-axis.", fig.width=8,fig.height=8,message=FALSE,warning=FALSE}
res <- spawnerinfcov(mod=1)

baseres=matrix(1,nrow(res),1)%*%matrix(as.numeric(res[1,2:ncol(res)]),nrow=1)
delaic=res[,2:ncol(res)]-baseres
rownames(delaic)=res$model

minrow <- apply(res[2:ncol(res)],2,function(x){which(x==min(x))})
baseres=matrix(1,nrow(res),1)%*%matrix(as.numeric(res[cbind(1,2:ncol(res))]),nrow=1)
delaic2=res[,2:ncol(res)]-baseres
rownames(delaic2)=res$model

library(tidyverse)
df <- gather(cbind(model=res$model, delaic2), year, aic, 2:ncol(delaic2))
df$DelAIC <- cut(df$aic, c(-100, -10, -2, 1,  100))
levels(df$DelAIC) <- c("Large improvement (< -10)", "Improved (-10 to -2)", "No improvement (0 to -2)", "Worsens model (> 0)")

p <- ggplot(df, aes(year, model)) +
  geom_tile(aes(fill = DelAIC), colour = "grey50")
p + theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1), aspect.ratio = 4/3)
```


Because the covariate tests indicated that 1994 was a very influential year for the environmental covariates, 1994 was removed. The Leave-one-out base model selection tests were therefore repeated with 1994 removed. Thus these tests have 1994 and one other year removed. With 1994 only removed, a linear model with Oct-Mar landings in the prior season was the only 'best' model for all but 3 years and for 2 of those 3, it was still within $\Delta$AIC of 2 of the best model and the year where $\Delta$AIC > 2 was 2.71.


```{r plot-spawners-cov2, echo=FALSE,fig.cap="Figure 1D. Delta AIC for the Jul-Sep landings base models with one year deleted. Deleted year is shown on the x-axis.", fig.width=8,fig.height=8,message=FALSE,warning=FALSE}
res <- spawnerinfcov(c(1987), mod=1)

baseres=matrix(1,nrow(res),1)%*%matrix(as.numeric(res[cbind(1,2:ncol(res))]),nrow=1)
delaic2=res[,2:ncol(res)]-baseres
delaic2=delaic2[,!(colnames(delaic2)%in%rmyr)]
rownames(delaic2)=res$model

library(tidyverse)
df <- gather(cbind(model=res$model, delaic2), year, aic, 2:ncol(delaic2))
df$DelAIC <- cut(df$aic, c(-100, -10, -2, 1,  100))
levels(df$DelAIC) <- c("Large improvement (< -10)", "Improved (-10 to -2)", "No improvement (1 to -2)", "Worsens model (> 1)")

p <- ggplot(df, aes(year, model)) +
  geom_tile(aes(fill = DelAIC), colour = "grey50")
p + theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1), aspect.ratio = 4/3)
```

```{r appd-spawners-cov-r2, echo=FALSE,fig.cap=paste0("Figure 5D. R-squared for the Oct-Mar landings base models with ", paste(rmyr, collapse=" and "), " and one additional year deleted. Deleted year is shown on the x-axis."), fig.width=8,fig.height=8,message=FALSE,warning=FALSE}
res <- spawnerinfcov(c(1987), resfun="r2", mod=1)

res=res[,!(colnames(res)%in%rmyr)]

library(tidyverse)
df <- gather(res, year, lev, 2:ncol(res))
df$r2 <- cut(df$lev, c(0, .2, .3, .4, .5, .6, .7, .8))
#levels(df$DelAIC) <- c("Best (0-0.5)", "Competitive (< 2)", "Uncompetitive (2-4)", "Poor (> 4)")
#ggplot(df, aes(year, model, fill = aic)) + geom_raster()

p <- ggplot(df, aes(year, model)) +
  geom_tile(aes(fill = r2), colour = "grey50")
p + theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1), aspect.ratio = 4/3)
```

```{r appd-spawners-cov-loo, echo=FALSE,fig.cap=paste0("Figure 5D. R-squared for the Oct-Mar landings base models with ", paste(rmyr, collapse=" and "), " and one additional year deleted. Deleted year is shown on the x-axis."), fig.width=8,fig.height=8,message=FALSE,warning=FALSE}
load("resloo.RData")
# res2 <- spawnerinfcov(resfun="loo")
# res <- nonspawnerinfcov(resfun="loo")

vals=res2
baseres=matrix(1,nrow(vals),1)%*%matrix(as.numeric(vals[cbind(1,2:ncol(vals))]),nrow=1)
tmp=vals[,2:ncol(vals)]-baseres
rownames(tmp)=vals$model

library(tidyverse)
df <- gather(cbind(model=vals$model, tmp), year, lev, 2:ncol(tmp))
df$r2 <- cut(df$lev, c(-.7,-.2,-.05,0.05,.7))
#levels(df$DelAIC) <- c("Best (0-0.5)", "Competitive (< 2)", "Uncompetitive (2-4)", "Poor (> 4)")
#ggplot(df, aes(year, model, fill = aic)) + geom_raster()

p <- ggplot(df, aes(year, model)) +
  geom_tile(aes(fill = r2), colour = "grey50")
p + theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1), aspect.ratio = 4/3)
```


## Validation of the Oct-Mar landings base models

```{r echo=FALSE}
rmyr <- c(1986, 1994)
```

 
```{r table-appD-nspawner, echo=FALSE}
nonspawnerinfcov <- function(rmyr=1900, resfun="aic"){
covnames=c(
           "precip.gpcp.kerala.mon6to7.0", "precip.gpcp.kerala.mon4to5.0",
           "precip.gpcp.kerala.mon6to7.1", "precip.gpcp.kerala.mon4to5.1",
           "SST.UPW.4.mon6to9.0", "SST.2.10.mon6to9.0", "Bakun.UPW.mon6to9.0",
           "SST.UPW.4.mon6to9.1", "SST.2.10.mon6to9.1", "Bakun.UPW.mon6to9.1",
           "SST.2.10.mon3to5.0", "SST.2.10.mon3to5.1",
           "SST.2.10.mon10to12.1",
           "SST.2.10.3.yr.runsum.0",
           "ONI.mon1to12.0", "DMI.mon9to11.0",
           "ONI.mon1to12.1", "DMI.mon9to11.1")
modnames=c(
           "Precip Jun-Jul(t)", "Precip Apr-May(t)",
           "Precip Jun-Jul(t-1)", "Precip Apr-May(t-1)",
           "SST-UPW Jun-Sep(t)", "SST Jun-Sep(t)", "Bakun-UPW Jun-Sep(t)",
           "SST-UPW Jun-Sep(t-1)", "SST Jun-Sep(t-1)", "Bakun-UPW Jun-Sep(t-1)",
           "SST Mar-May(t)", "SST Mar-May(t-1)",
           "SST Oct-Dec(t-1)",
           "2.5 yr ave SST",
           "ONI(t)", "DMI Sep-Nov(t)",
           "ONI(t-1)", "DMI Sep-Nov(t-1)")

## SPAWNERS
dat=dat.nonspawners
dat$nspawners0[dat$Year%in%rmyr]=NA

m0 = gam(nspawners0 ~ s(nspawners1, sp=0.6) + s(spawners2, sp=0.6), data=dat)
res = data.frame(model="base)", None=ret(m0, resfun))
for(i in 1:length(covnames)){
  cov <- covnames[i]
  dat$cov=dat[[cov]]
  m0 = gam(nspawners0 ~ s(nspawners1, sp=0.6) + s(spawners2, sp=0.6) + cov, data=dat)
  tmp = data.frame(model=paste0("lin(", modnames[i], ")"), None=ret(m0, resfun))
  res = rbind(res, tmp)
  m0 = gam(nspawners0 ~  s(nspawners1, sp=0.6) + s(spawners2, sp=0.6) + s(cov, sp=0.6), data=dat)
  tmp = data.frame(model=paste0("gam(", modnames[i], ")"), None=ret(m0, resfun))
  res = rbind(res, tmp)
}

for(yr in 1984:2014){
  bad = yr
  dat2=dat
  dat2$nspawners0[dat$Year%in%bad]=NA
  #dat2$nspawners1[dat$Year%in%(bad+1)]=NA
  m0 = gam(nspawners0 ~ s(nspawners1, sp=0.6) + s(spawners2, sp=0.6), data=dat2)
  tmpres = data.frame(model="base: lin(Oct-Mar landings t-1)",None=ret(m0, resfun))

for(i in 1:length(covnames)){
  cov <- covnames[i]
  dat2$cov=dat2[[cov]]
  m0 = gam(nspawners0 ~ s(nspawners1, sp=0.6) + s(spawners2, sp=0.6) + cov, data=dat2)
  tmp = data.frame(model=paste0("lin(", modnames[i], ")"), None=ret(m0, resfun))
  tmpres = rbind(tmpres, tmp)
  m0 = gam(nspawners0 ~ s(nspawners1, sp=0.6) + s(spawners2, sp=0.6) + s(cov, sp=0.6), data=dat2)
  tmp = data.frame(model=paste0("gam(", modnames[i], ")"), None=ret(m0, resfun))
  tmpres = rbind(tmpres, tmp)
}
  colnames(tmpres)=c("model", yr)
  res=cbind(res,tmpres[,2,drop=FALSE])
}

return(res)
}
```


The Figure 3D shows that for Oct-Mar landings the best model was always GAM with Oct-Mar in the prior season and Jul-Sep landings two seasons prior.

```{r test.nspawners, echo=FALSE,fig.cap="Figure 3D. Delta AIC for the Jul-Oct landings base models with one year deleted. Deleted year is shown on the x-axis.", fig.width=8,fig.height=8,message=FALSE,warning=FALSE}
res <- nonspawnerinfcov()

baseres=matrix(1,nrow(res),1)%*%matrix(as.numeric(res[cbind(1,2:ncol(res))]),nrow=1)
delaic2=res[,2:ncol(res)]-baseres
rownames(delaic2)=res$model

library(tidyverse)
delaic2 <- cbind(model=res$model, delaic2)
df <- gather(delaic2, year, aic, 2:ncol(delaic2))
# df$DelAIC <- cut(df$aic, c(-0.001, .5, 2, 4, 100))
# levels(df$DelAIC) <- c("Best (0-0.5)", "Competitive (< 2)", "Uncompetitive (2-4)", "Poor (> 4)")
df$DelAIC <- cut(df$aic, c(-100, -10, -2,  100))
levels(df$DelAIC) <- c("Large improvement (< -10)", "Improved (-10 to -2)", "No improvement (> -2)", "Worsens model (> 1)")[1:3]
#ggplot(df, aes(year, model, fill = aic)) + geom_raster()

p <- ggplot(df, aes(year, model)) +
  geom_tile(aes(fill = DelAIC), colour = "grey50")
p + theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1), aspect.ratio = 4/3)
```


Again 1994 was deleted and the leave-one-out analysis was repeated. The Figure 4D shows the best model is still always GAM with Oct-Mar in the prior season and Jul-Sep landings two seasons prior.

```{r plot-nspawners-cov2, echo=FALSE,fig.cap="Figure 1D. Delta AIC for the Oct-Mar landings base models with one year deleted. Deleted year is shown on the x-axis.", fig.width=8,fig.height=8,message=FALSE,warning=FALSE}
rmyr <- c(1994,1987)
res <- nonspawnerinfcov(rmyr)
res=res[,!(colnames(res)%in%rmyr)]

baseres=matrix(1,nrow(res),1)%*%matrix(as.numeric(res[cbind(1,2:ncol(res))]),nrow=1)
delaic2=res[,2:ncol(res)]-baseres
rownames(delaic2)=res$model

library(tidyverse)
delaic2 <- cbind(model=res$model, delaic2)
df <- gather(delaic2, year, aic, 2:ncol(delaic2))
# df$DelAIC <- cut(df$aic, c(-0.001, .5, 2, 4, 100))
# levels(df$DelAIC) <- c("Best (0-0.5)", "Competitive (< 2)", "Uncompetitive (2-4)", "Poor (> 4)")
df$DelAIC <- cut(df$aic, c(-100, -10, -2,  100))
levels(df$DelAIC) <- c("Large improvement (< -10)", "Improved (-10 to -2)", "No improvement (> -2)")
#ggplot(df, aes(year, model, fill = aic)) + geom_raster()

p <- ggplot(df, aes(year, model)) +
  geom_tile(aes(fill = DelAIC), colour = "grey50")
p + theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1), aspect.ratio = 4/3)
```
```{r appd-nspawners-cov-r2, echo=FALSE,fig.cap=paste0("Figure 5D. R-squared for the Oct-Mar landings base models with ", paste(rmyr, collapse=" and "), " and one additional year deleted. Deleted year is shown on the x-axis."), fig.width=8,fig.height=8,message=FALSE,warning=FALSE}
res <- nonspawnerinfcov(resfun="r2")

library(tidyverse)
df <- gather(res, year, lev, 2:ncol(res))
df$r2 <- cut(df$lev, c(0, .2, .3, .4, .5, .6, .7, .8, .9))
#levels(df$DelAIC) <- c("Best (0-0.5)", "Competitive (< 2)", "Uncompetitive (2-4)", "Poor (> 4)")
#ggplot(df, aes(year, model, fill = aic)) + geom_raster()

p <- ggplot(df, aes(year, model)) +
  geom_tile(aes(fill = r2), colour = "grey50")
p + theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1), aspect.ratio = 4/3)
```

```{r appd-nspawners-cov-r2b, echo=FALSE,fig.cap=paste0("Figure 5D. R-squared for the Oct-Mar landings base models with ", paste(rmyr, collapse=" and "), " and one additional year deleted. Deleted year is shown on the x-axis."), fig.width=8,fig.height=8,message=FALSE,warning=FALSE}
res <- nonspawnerinfcov(rmyr, resfun="r2")
res=res[,!(colnames(res)%in%rmyr)]

library(tidyverse)
df <- gather(res, year, lev, 2:ncol(res))
df$r2 <- cut(df$lev, c(0, .2, .3, .4, .5, .6, .7, .8, .9))
#levels(df$DelAIC) <- c("Best (0-0.5)", "Competitive (< 2)", "Uncompetitive (2-4)", "Poor (> 4)")
#ggplot(df, aes(year, model, fill = aic)) + geom_raster()

p <- ggplot(df, aes(year, model)) +
  geom_tile(aes(fill = r2), colour = "grey50")
p + theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1), aspect.ratio = 4/3)
```


```{r appd-nspawners-cov-loo, echo=FALSE,fig.cap=paste0("Figure 5D. R-squared for the Oct-Mar landings base models with ", paste(rmyr, collapse=" and "), " and one additional year deleted. Deleted year is shown on the x-axis."), fig.width=8,fig.height=8,message=FALSE,warning=FALSE}
load("resloo.RData")
# res2 <- spawnerinfcov(resfun="loo")
# res <- nonspawnerinfcov(resfun="loo")

vals=res
baseres=matrix(1,nrow(vals),1)%*%matrix(as.numeric(vals[cbind(1,2:ncol(vals))]),nrow=1)
tmp=vals[,2:ncol(vals)]-baseres
rownames(tmp)=vals$model

library(tidyverse)
df <- gather(cbind(model=vals$model, tmp), year, lev, 2:ncol(tmp))
df$r2 <- cut(df$lev, c(-.7,-.2,-.05,0.05,.7))
#levels(df$DelAIC) <- c("Best (0-0.5)", "Competitive (< 2)", "Uncompetitive (2-4)", "Poor (> 4)")
#ggplot(df, aes(year, model, fill = aic)) + geom_raster()

p <- ggplot(df, aes(year, model)) +
  geom_tile(aes(fill = r2), colour = "grey50")
p + theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1), aspect.ratio = 4/3)
```

```{r, results="asis", echo=FALSE}
cat("\\clearpage")
```
