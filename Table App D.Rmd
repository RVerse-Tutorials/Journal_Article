---
title: "Influential Years Analysis: only past catch"
output:
  pdf_document: default
  word_document: default
header-includes: \usepackage[labelformat=empty]{caption}
---

```{r child = 'setup.Rmd'}
```

```{r funs, echo=FALSE}
library(mgcv)
library(SardineForecast)
ret <- function(mod, resfun){
    if(resfun=="aic") return(mod$aic)
    if(resfun=="aicc") return(SardineForecast:::AICcgam(mod))
    if(resfun=="loo") return(SardineForecast:::loogam(mod)$RMSE)
    if(resfun=="looMd") return(SardineForecast:::loogam(mod)$MdAE)
    if(resfun=="r2") return(summary(mod)$r.sq)
  }
rmyr <- c(1986, 1994)
Palette4 <- c("#000000", "#999999", "#F0E442", "#D55E00")
mods <- c("base", "lin(Jul-Sep(t-1))", "gam(Jul-Sep(t-1))", "lin(Jul-Sep(t-1)), lin(Jul-Sep(t-2))", "gam(Jul-Sep(t-1)), gam(Jul-Sep(t-2))", "lin(Oct-Mar(t-1))", "gam(Oct-Mar(t-1))", "lin(Oct-Mar(t-1)), lin(Oct-Mar(t-2))", "gam(Oct-Mar(t-1)), gam(Oct-Mar(t-2))", "lin(Jul-Sep(t-1)), lin(Oct-Mar(t-2))", "gam(Jul-Sep(t-1)), gam(Oct-Mar(t-2))", "lin(Oct-Mar(t-1)), lin(Jul-Sep(t-2))", "gam(Oct-Mar(t-1)), gam(Jul-Sep(t-2))", "lin(Oct-Mar(t-1)), lin(Jul-Sep(t-1))", "gam(Oct-Mar(t-1)), gam(Jul-Sep(t-1))")
modelset <- mods[c(2,3,5,6,7,9, 11, 13, 15)]
modelset <- mods[-1]
modelset <- mods[seq(3,15,2)]
modelset <- mods[2:13]
aspr <- 3/3
figh <- 3.5
```

## Validation of the Jul-Sep landings base models

To evaluate the base model for the Jul-Sep landings using only prior catch as covariates, GAM and linear models with Jul-Sep and Oct-Mar in the prior season and two seasons prior as covariates were fit to the 1984-2015 landings. The models were fit leaving one year out (year shown on the x-axis). The far right shows the fit to all years. 

In Figure 1D, the $\Delta$AIC values are the AIC minus the AIC of the best model (model with lowest AIC). Models with $\Delta$AIC with 0.5 are similar and "best". Models within 2 of the best models are competitive. Models with $\Delta$AIC greater than 2 are uncompetitive.

The Figure 1D shows that with any year left out, the set of models that has the lowest AIC was always GAM with Oct-Mar and Jul-Sep landings in the prior season or GAM with only Oct-Mar landings in the prior season. There were cases where deleting a year removed one of these two from the 'best' category, but they were still in the 'competitive category. However, when we look at the Leave-one-out predictive performance (Figure 2D), we see that the GAM with Oct-Mar and Jul-Sep landings in the prior season is better than the GAM with only Oct-Mar landings---except when 1995 or 1987-88 are left out. 

This suggests that the better predictive performance is due to better prediction of 1994-95 or 1987-8.  The covariate analysis also indicated that 1994-95 have a strong influence on the selected models. This is not entirely surprising since 1994 was a year of a severe decline and 1995 a year when the landings rebounded.  The analysis was repeated with 1994 and 1995 removed (Figure 3D and 4D). With these 2 years removed, the GAM with Oct-Mar landings in prior season only is the model with lowest AIC and LOO predictive performance regardless of which year is removed. Thus, the GAM with Oct-Mar landings in the prior season only was choosen as the base model for Jul-Sep landings.

It should be noted that none of the models has a particularly high adjusted R$^2$ (Figure 5D). The values are generally less than 0.3. The Jul-Sep landings tend to be highly variable and not related to the catch in prior years. Jul-Sep is during the monsoon during which fishing is not always possible due to sea-state and there is a 6-week fishing ban during this time.

```{r table-appD-fits, echo=FALSE}
spawnerinf <- function(rmyr=1900, resfun="aic", data=dat.nonspawners){

  covnames=c("nspawners1", "spawners1",
           "nspawners2", "spawners2")
modnames=c("Oct-Mar(t-1)", "Jul-Sep(t-1)",
           "Oct-Mar(t-2)", "Jul-Sep(t-2)")

tests=list(c(2),c(2,4),c(1),c(1,3),c(2,3), c(1,4),c(1,2))
## SPAWNERS
dat=data
dat$spawners0[dat$Year%in%rmyr]=NA
m0 = gam(spawners0 ~ spawners1, data=dat)
res = data.frame(model="base", None=ret(m0, resfun))

for(val in tests){
  if(length(val)==1){
  dat$cov1=dat[[covnames[val[1]]]]
  m0 = gam(spawners0 ~ cov1, data=dat)
  tmp = data.frame(model=paste0("lin(", modnames[val[1]],")"), None=ret(m0, resfun))
  res = rbind(res, tmp)
  m0 = gam(spawners0 ~ s(cov1, sp=0.6), data=dat)
  tmp = data.frame(model=paste0("gam(", modnames[val[1]],")"), None=ret(m0, resfun))
  res = rbind(res, tmp)
  }else{
    dat$cov1=dat[[covnames[val[1]]]]
    dat$cov2=dat[[covnames[val[2]]]]
    m0 = gam(spawners0 ~ cov1 + cov2, data=dat)
    tmp = data.frame(model=paste0("lin(", modnames[val[1]], "), lin(", modnames[val[2]], ")"), None=ret(m0, resfun))
    res = rbind(res, tmp)
    m0 = gam(spawners0 ~ s(cov1,sp=0.6) + s(cov2,sp=0.6), data=dat)
    tmp = data.frame(model=paste0("gam(", modnames[val[1]], "), gam(", modnames[val[2]], ")"), None=ret(m0, resfun))
    res = rbind(res, tmp)
    # m0 = gam(spawners0 ~ s(cov1,sp=0.6) + cov2, data=dat)
    # tmp = data.frame(model=paste0("gam(", modnames[val[1]], "), lin(", modnames[val[2]], ")"), None=ret(m0, resfun))
    # res = rbind(res, tmp)
    # m0 = gam(spawners0 ~ cov1 + s(cov2,sp=0.6), data=dat)
    # nm = 
    # tmp = data.frame(model=paste0("lin(", modnames[val[1]], "), gam(", modnames[val[2]], ")"), None=ret(m0, resfun))
    # res = rbind(res, tmp)
  }
}

for(yr in min(dat$Year):max(dat$Year)){
  bad = yr
  dat2=dat
  dat2$spawners0[dat$Year%in%bad]=NA
  m0 = gam(spawners0 ~ spawners1, data=dat2)
  tmpres = data.frame(model="Intercept only",None=ret(m0, resfun))
  
  for(val in tests){
    if(length(val)==1){
      dat2$cov1=dat[[covnames[val[1]]]]
      m0 = gam(spawners0 ~ cov1, data=dat2)
      tmp = data.frame(model=paste0("lm(", modnames[val[1]],")"), None=ret(m0, resfun))
      tmpres = rbind(tmpres, tmp)
      m0 = gam(spawners0 ~ s(cov1, sp=0.6), data=dat2)
      tmp = data.frame(model=paste0("gam(", modnames[val[1]],")"), None=ret(m0, resfun))
      tmpres = rbind(tmpres, tmp)
    }else{
      dat2$cov1=dat[[covnames[val[1]]]]
      dat2$cov2=dat[[covnames[val[2]]]]
      m0 = gam(spawners0 ~ cov1 + cov2, data=dat2)
      tmp = data.frame(model=paste0("lm(", modnames[val[1]], ", ", covnames[val[2]], ")"), None=ret(m0, resfun))
      tmpres = rbind(tmpres, tmp)
      m0 = gam(spawners0 ~ s(cov1,sp=0.6) + s(cov2,sp=0.6), data=dat2)
      tmp = data.frame(model=paste0("gam(", modnames[val[1]], ", ", covnames[val[2]],")"), None=ret(m0, resfun))
      tmpres = rbind(tmpres, tmp)
      # m0 = gam(spawners0 ~ s(cov1,sp=0.6) + cov2, data=dat2)
      # tmp = data.frame(model=paste0("gam(", modnames[val[1]], "), lin(", modnames[val[2]], ")"), None=ret(m0, resfun))
      # tmpres = rbind(tmpres, tmp)
      # m0 = gam(spawners0 ~ cov1 + s(cov2,sp=0.6), data=dat2)
      # tmp = data.frame(model=paste0("lin(", modnames[val[1]], "), gam(", modnames[val[2]], ")"), None=ret(m0, resfun))
      # tmpres = rbind(tmpres, tmp)
    }
  }
  colnames(tmpres)=c("model", yr)
  res=cbind(res,tmpres[,2,drop=FALSE])
}
return(res)
}
```

```{r table-appD-fits-loofits, echo=FALSE}
fits <- function(rmyr=1900, resp="spawners0", data=dat.nonspawners){

  covnames=c("nspawners1", "spawners1",
           "nspawners2", "spawners2")
modnames=c("Oct-Mar(t-1)", "Jul-Sep(t-1)",
           "Oct-Mar(t-2)", "Jul-Sep(t-2)")

tests=list(c(2),c(2,4),c(1),c(1,3),c(2,3), c(1,4),c(1,2))
## SPAWNERS
dat=data
dat[[resp]][dat$Year%in%rmyr]=NA
dat$resp = dat[[resp]]
m0 = gam(resp ~ 1, data=dat)
m0$data = dat[,c("Year","resp")]
res = list(intercept=m0)
resloo = list(intercept=list(data=dat[,c("Year","resp")],
                             pred=SardineForecast:::loogam(m0)$pred))

for(val in tests){
  if(length(val)==1){
  dat$cov1=dat[[covnames[val[1]]]]
  m0 = gam(resp ~ cov1, data=dat)
  m0$data = dat[,c("Year","resp", "cov1")]
  modname = paste0("lin(", modnames[val[1]],")")
  res[[modname]] = m0
  resloo[[modname]] = list(data=dat[,c("Year","resp", "cov1")],
                           pred=SardineForecast:::loogam(m0)$pred)
  m0 = gam(resp ~ s(cov1, sp=0.6), data=dat)
  m0$data = dat[,c("Year","resp", "cov1")]
  modname = paste0("gam(", modnames[val[1]],")")
  res[[modname]] = m0
  resloo[[modname]] = list(data=dat[,c("Year","resp", "cov1")],
                           pred=SardineForecast:::loogam(m0)$pred)
  }else{
    dat$cov1=dat[[covnames[val[1]]]]
    dat$cov2=dat[[covnames[val[2]]]]
    m0 = gam(resp ~ cov1 + cov2, data=dat)
    m0$data = dat[,c("Year","resp", "cov1", "cov2")]
    modname=paste0("lin(", modnames[val[1]], "), lin(", modnames[val[2]], ")")
    res[[modname]] = m0
    resloo[[modname]] = list(data=dat[,c("Year","resp", "cov1", "cov2")],
                             pred=SardineForecast:::loogam(m0)$pred)
    m0 = gam(resp ~ s(cov1,sp=0.6) + s(cov2,sp=0.6), data=dat)
    m0$data = dat[,c("Year","resp", "cov1", "cov2")]
    modname=paste0("gam(", modnames[val[1]], "), gam(", modnames[val[2]], ")")
    res[[modname]] = m0
    resloo[[modname]] = list(data=dat[,c("Year","resp", "cov1", "cov2")],
                             pred=SardineForecast:::loogam(m0)$pred)
  }
}

return(list(Fitted=res, LooPred=resloo))
}
```


```{r appD-spawners-aic, echo=FALSE, fig.cap="Figure 1D. Delta AIC for the Jul-Sep landings base models with one year deleted. Delta AIC is AIC of the model minus the AIC of the best (lowest AIC model) in the set. Black models were the best models in the set and within 0.5 AIC of each other. Green are models within 2 of the best model, thus competitive to the best models. Deleted year is shown on the x-axis.", fig.width=8, fig.height=figh, message=FALSE, warning=FALSE}
res <- spawnerinf(resfun="aicc")
res <- res[res$model%in%modelset,]
baseres=matrix(1,nrow(res),1)%*%matrix(as.numeric(res[1,2:ncol(res)]),nrow=1)
delaic=res[,2:ncol(res)]-baseres
rownames(delaic)=res$model

minrow <- apply(res[2:ncol(res)],2,function(x){which(x==min(x))})
baseres=matrix(1,nrow(res),1)%*%matrix(as.numeric(res[cbind(minrow,2:ncol(res))]),nrow=1)
delaic2=res[,2:ncol(res)]-baseres
rownames(delaic2)=res$model

library(tidyverse)
df <- gather(cbind(model=res$model, delaic2), year, aic, 2:ncol(delaic2))
df$DelAICc <- cut(df$aic, c(-0.001, .5, 2, 4, 100))
levels(df$DelAICc) <- c("Best (0-0.5)", "Competitive (< 2)", "Uncompetitive (2-4)", "Poor (> 4)")
#ggplot(df, aes(year, model, fill = aic)) + geom_raster()

p <- ggplot(df, aes(year, model)) +
  geom_tile(aes(fill = DelAICc), colour = "grey50")
p + theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1), aspect.ratio = aspr) + scale_fill_manual(values=Palette4)
```

```{r appD-spawners-fits1, echo=FALSE, fig.cap="Figure 1D. Delta AIC for the Jul-Sep landings base models with one year deleted. Delta AIC is AIC of the model minus the AIC of the best (lowest AIC model) in the set. Black models were the best models in the set and within 0.5 AIC of each other. Green are models within 2 of the best model, thus competitive to the best models. Deleted year is shown on the x-axis.", fig.width=8, fig.height=figh, message=FALSE, warning=FALSE}
dforig=data.frame(Year=respdat$Year, 
              spawners0=respdat$spawners0, spawners1=respdat$spawners1, spawners2=respdat$spawners2, 
              nspawners0=respdat$nspawners0, nspawners1=respdat$nspawners1, 
               nspawners2=respdat$nspawners2)
FittedLooPred <- fits(data=dforig)
myfits <- FittedLooPred$Fitted
fit <- myfits[[1]]
p <- ggplot() + geom_point(data=fit$data, aes(x=Year, y=resp, color="Actual"))
for(fit in myfits){
  tmp <- data.frame(Year=na.omit(fit$data)$Year, fitted=fitted(fit))
  p <- p + geom_line(data=tmp, aes(x=Year, y=fitted, color="Predicted"))
}
p1 <- p + scale_color_manual( values = c( Actual="black", Predicted="blue")) +  labs(color="") + xlab('') +  ylab('Jul-Sep Catch') + theme_classic() + theme(legend.position = "none")

myfits <- FittedLooPred$LooPred
fit <- myfits[[1]]
p <- ggplot() + geom_point(data=fit$data, aes(x=Year, y=resp, color="Actual"))
for(fit in myfits){
  tmp <- data.frame(Year=na.omit(fit$data)$Year, pred=fit$pred)
  p <- p + geom_line(data=tmp, aes(x=Year, y=pred, color="Predicted"))
}
p2 <- p + scale_color_manual( values = c( Actual="black", Predicted="blue")) +  labs(color="LOO CV") + xlab('') +  ylab('Jul-Sep Catch') + theme_classic() + theme(legend.position = "none")

FittedLooPred <- fits(rmyr=c(1956, 1957, 1986,1987, 1994, 1995), data=dforig)
myfits <- FittedLooPred$Fitted
fit <- myfits[[1]]
p <- ggplot() + geom_point(data=fit$data, aes(x=Year, y=resp, color="Actual"))
for(fit in myfits){
  tmp <- data.frame(Year=na.omit(fit$data)$Year, fitted=fitted(fit))
  p <- p + geom_line(data=tmp, aes(x=Year, y=fitted, color="Predicted"))
}
p3 <- p + scale_color_manual( values = c( Actual="black", Predicted="blue")) +  labs(color="One-step ahead") + xlab('') +  ylab('Jul-Sep Catch') + theme_classic() + theme(
  legend.justification = c(1,0), legend.position = c(1,0),
  legend.key = element_rect(colour = "transparent", fill = "white"))

myfits <- FittedLooPred$LooPred
fit <- myfits[[1]]
p <- ggplot() + geom_point(data=fit$data, aes(x=Year, y=resp, color="Actual"))
for(fit in myfits){
  tmp <- data.frame(Year=na.omit(fit$data)$Year, pred=fit$pred)
  p <- p + geom_line(data=tmp, aes(x=Year, y=pred, color="Predicted"))
}
p4 <- p + scale_color_manual( values = c( Actual="black", Predicted="blue")) +  labs(color="LOO") + xlab('') +  ylab('Jul-Sep Catch') + theme_classic() + theme(
  legend.justification = c(1,0), legend.position = c(1,0),
  legend.key = element_rect(colour = "transparent", fill = "white"))

gridExtra::grid.arrange(p1, p3, p2, p4, nrow = 2)
```



```{r appD-spawners-fits2, echo=FALSE, fig.cap="Figure 1D. Delta AIC for the Jul-Sep landings base models with one year deleted. Delta AIC is AIC of the model minus the AIC of the best (lowest AIC model) in the set. Black models were the best models in the set and within 0.5 AIC of each other. Green are models within 2 of the best model, thus competitive to the best models. Deleted year is shown on the x-axis.", fig.width=8, fig.height=figh, message=FALSE, warning=FALSE}
library(grid)
dforig=data.frame(Year=respdat$Year, 
              spawners0=respdat$spawners0, spawners1=respdat$spawners1, spawners2=respdat$spawners2, 
              nspawners0=respdat$nspawners0, nspawners1=respdat$nspawners1, 
               nspawners2=respdat$nspawners2)
FittedLooPred <- fits(data=dforig)
myfits <- FittedLooPred$LooPred
linmods = stringr::str_detect(names(myfits),"lin")
fit <- myfits[[1]]
p <- ggplot() + geom_point(data=fit$data, aes(x=Year, y=resp, color="Actual"))
for(fit in myfits[linmods]){
  tmp <- data.frame(Year=na.omit(fit$data)$Year, pred=fit$pred)
  p <- p + geom_line(data=tmp, aes(x=Year, y=pred, color="Predicted"))
}
p1 <- p + scale_color_manual( values = c( Actual="black", Predicted="blue")) +  labs(color="One-step-ahead") + xlab('') +  ylab('Jul-Sep Catch') + theme_classic() + theme(
  legend.justification = c(1,0), legend.position = c(1,0),
  legend.key = element_rect(colour = "transparent", fill = "white"))
grob <- grobTree(textGrob("linear models", x=0.1,  y=0.95, hjust=0, gp=gpar(col="blue", fontsize=13)))
p1 <- p1 + annotation_custom(grob)

gammods = stringr::str_detect(names(myfits),"gam")
fit <- myfits[[1]]
p <- ggplot() + geom_point(data=fit$data, aes(x=Year, y=resp, color="Actual"))
for(fit in myfits[gammods]){
  tmp <- data.frame(Year=na.omit(fit$data)$Year, pred=fit$pred)
  p <- p + geom_line(data=tmp, aes(x=Year, y=pred, color="Predicted"))
}
p2 <- p + scale_color_manual( values = c( Actual="black", Predicted="blue")) +  labs(color="One-step-ahead") + xlab('') +  ylab('Jul-Sep Catch') + theme_classic() + theme(
  legend.justification = c(1,0), legend.position = c(1,0),
  legend.key = element_rect(colour = "transparent", fill = "white"))
grob <- grobTree(textGrob("GAM models", x=0.1,  y=0.95, hjust=0, gp=gpar(col="blue", fontsize=13)))
p2 <- p2 + annotation_custom(grob)

gammods = stringr::str_detect(names(myfits),"gam")
fit <- myfits[[1]]
p <- ggplot() + geom_point(data=fit$data, aes(x=Year, y=resp, color="Actual"))
for(fit in myfits[gammods]){
  tmp <- data.frame(Year=na.omit(fit$data)$Year, fitted=fitted(fit))
  p <- p + geom_line(data=tmp, aes(x=Year, y=fitted, color="Predicted"))
}
p3 <- p + scale_color_manual( values = c( Actual="black", Predicted="blue")) +  labs(color="One-step ahead") + xlab('') +  ylab('Jul-Sep Catch') + theme_classic() + theme(
  legend.justification = c(1,0), legend.position = c(1,0),
  legend.key = element_rect(colour = "transparent", fill = "white"))

myfits <- FittedLooPred$LooPred
fit <- myfits[[1]]
p <- ggplot() + geom_point(data=fit$data, aes(x=Year, y=resp, color="Actual"))
for(fit in myfits){
  tmp <- data.frame(Year=na.omit(fit$data)$Year, pred=fit$pred)
  p <- p + geom_line(data=tmp, aes(x=Year, y=pred, color="Predicted"))
}
p4 <- p + scale_color_manual( values = c( Actual="black", Predicted="blue")) +  labs(color="LOO") + xlab('') +  ylab('Jul-Sep Catch') + theme_classic() + theme(
  legend.justification = c(1,0), legend.position = c(1,0),
  legend.key = element_rect(colour = "transparent", fill = "white"))

gridExtra::grid.arrange(p1, p3, p2, p4, nrow = 2)
```

```{r appd-spawners-loo, echo=FALSE, fig.cap="Figure 2D. Leave-one-out predictive performance (leave out a year, fit, predict that year) for the Jul-Sep landings base models. The performance (DelLOO) is the RSME (root mean square error) from LOO from all models was compared to the LOO RSME for a base model: GAM(Oct-Mar(t-1)). Thus results are relative to the GAM(Oct-Mar(t-1)) model. Black is better predictive performance relative to this model, green is similar, and yellow and orange are worse.", fig.width=8, fig.height=figh, message=FALSE, warning=FALSE}

# res2 <- spawnerinf(resfun="loo")
# res <- nspawnerinf(resfun="loo")
# save(res, res2, file="basemodsloo.RData")
load("basemodsloo.RData")
vals=res2.all
vals <- vals[vals$model%in%modelset,]
minrow <- apply(vals[,2:ncol(vals)],2,function(x){which(x==min(x))})
baseres=matrix(1,nrow(vals),1)%*%matrix(as.numeric(vals[cbind(minrow,2:ncol(vals))]),nrow=1)
tmp=vals[,2:ncol(vals)]/baseres
rownames(tmp)=vals$model

library(tidyverse)
df <- gather(cbind(model=vals$model, tmp), year, lev, 2:ncol(tmp))
df$DelLOO <- cut(df$lev, c(-.2,-.01,0.01,.05,1))
df$DelLOO <- cut(df$lev, c(.999,1.01,1.05,1.10,1.2,3))
levels(df$DelLOO) <- c("Best (< 1%)", "Similar (1-2%)", "Worse (5-10%)", "Much worse (10-20%)", "Worst (>20%)")

p <- ggplot(df, aes(year, model)) +
  geom_tile(aes(fill = DelLOO), colour = "grey50")
p + theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1), aspect.ratio = aspr) + scale_fill_manual(values=c(Palette4,"red"))
```


```{r appd-spawners2-aic-9495, echo=FALSE,fig.cap="Figure 3D. Delta AIC for the Jul-Sep landings base models with 1995 and one other year deleted. The deleted year is shown on the x-axis.", fig.width=8, fig.height=figh, message=FALSE, warning=FALSE}
res <- spawnerinf(rmyr, resfun="aicc")
res <- res[res$model%in%modelset,]

minrow <- apply(res[2:ncol(res)],2,function(x){which(x==min(x))})
baseres=matrix(1,nrow(res),1)%*%matrix(as.numeric(res[cbind(minrow,2:ncol(res))]),nrow=1)
delaic2=res[,2:ncol(res)]-baseres
delaic2=delaic2[,!(colnames(delaic2)%in%rmyr)]
rownames(delaic2)=res$model

library(tidyverse)
df <- gather(cbind(model=res$model, delaic2), year, aic, 2:ncol(delaic2))
df$DelAIC <- cut(df$aic, c(-0.001, .5, 2, 4, 100))
levels(df$DelAIC) <- c("Best (0-0.5)", "Competitive (< 2)", "Uncompetitive (2-4)", "Poor (> 4)")

p <- ggplot(df, aes(year, model)) +
  geom_tile(aes(fill = DelAIC), colour = "grey50")
p + theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1), aspect.ratio = aspr) + scale_fill_manual(values=Palette4)
```

```{r appd-spawners-loo-9495, echo=FALSE,fig.cap="Figure 4D. Leave-one-out predictive performance for the Jul-Sep landings base models with 1995 removed. See Figure 2D for details on the figure.", fig.width=8, fig.height=figh, message=FALSE, warning=FALSE}
# res2 <- spawnerinf(resfun="loo")
# res <- nspawnerinf(resfun="loo")
# save(res, res2, file="basemodsloo.RData")
load("basemodsloo.RData")
vals=res2.8694
vals <- vals[vals$model%in%modelset,]
minrow <- apply(vals[,2:ncol(vals)],2,function(x){which(x==min(x))})
baseres=matrix(1,nrow(vals),1)%*%matrix(as.numeric(vals[cbind(minrow,2:ncol(vals))]),nrow=1)
tmp=vals[,2:ncol(vals)]/baseres
rownames(tmp)=vals$model

library(tidyverse)
df <- gather(cbind(model=vals$model, tmp), year, lev, 2:ncol(tmp))
df$DelLOO <- cut(df$lev, c(-.2,-.01,0.01,.05,1))
df$DelLOO <- cut(df$lev, c(.999,1.01,1.05,1.10,1.2,3))
levels(df$DelLOO) <- c("Best (< 1%)", "Similar (1-2%)", "Worse (5-10%)", "Much worse (10-20%)", "Worst (>20%)")
p <- ggplot(df, aes(year, model)) +
  geom_tile(aes(fill = DelLOO), colour = "grey50")
p + theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1), aspect.ratio = aspr) + scale_fill_manual(values=c(Palette4,"red"))
```

```{r appd-spawners-r2, echo=FALSE,fig.cap=paste0("Figure 5D. R-squared for the Jul-Sep landings base models with one year deleted. The deleted year is shown on the x-axis."), fig.width=8,fig.height=figh,message=FALSE,warning=FALSE}
res <- spawnerinf(rmyr, resfun="r2")
res <- res[res$model%in%modelset,]

library(tidyverse)
df <- gather(res, year, lev, 2:ncol(res))
df$r2 <- cut(df$lev, c(0, .3, .5, .6, .7))

p <- ggplot(df, aes(year, model)) +
  geom_tile(aes(fill = r2), colour = "grey50")
p + theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1), aspect.ratio = aspr) + scale_fill_manual(values=Palette4)
```

```{r, results="asis", echo=FALSE}
cat("\\clearpage")
```

## Validation of the Oct-Mar landings base models

The Figure 6D shows that for Oct-Mar landings the best model was always GAM with Oct-Mar in the prior season and Jul-Sep landings two seasons prior.  


Again `r paste(rmyr, collapse=" and ")` `r ifelse(length(rmyr)==1,"was","were")` deleted and the leave-one-out analysis was repeated. The Figure 4D shows the best model is still always GAM with Oct-Mar in the prior season and Jul-Sep landings two seasons prior.

 
```{r table-appD-nspawner, echo=FALSE}
nspawnerinf <- function(rmyr=1900, resfun="aic", data=dat.nonspawners){

  covnames=c("nspawners1", "spawners1",
           "nspawners2", "spawners2")
modnames=c("Oct-Mar(t-1)", "Jul-Sep(t-1)",
           "Oct-Mar(t-2)", "Jul-Sep(t-2)")

tests=list(c(2),c(2,4),c(1),c(1,3),c(2,3), c(1,4),c(1,2))
## SPAWNERS
dat=data
dat$nspawners0[dat$Year%in%rmyr]=NA
m0 = gam(nspawners0 ~ nspawners1, data=dat)
res = data.frame(model="base", None=ret(m0, resfun))

for(val in tests){
  if(length(val)==1){
  dat$cov1=dat[[covnames[val[1]]]]
  m0 = gam(nspawners0 ~ cov1, data=dat)
  tmp = data.frame(model=paste0("lin(", modnames[val[1]],")"), None=ret(m0, resfun))
  res = rbind(res, tmp)
  m0 = gam(nspawners0 ~ s(cov1, sp=0.6), data=dat)
  tmp = data.frame(model=paste0("gam(", modnames[val[1]],")"), None=ret(m0, resfun))
  res = rbind(res, tmp)
  }else{
    dat$cov1=dat[[covnames[val[1]]]]
    dat$cov2=dat[[covnames[val[2]]]]
    m0 = gam(nspawners0 ~ cov1 + cov2, data=dat)
    tmp = data.frame(model=paste0("lin(", modnames[val[1]], "), lin(", modnames[val[2]], ")"), None=ret(m0, resfun))
    res = rbind(res, tmp)
    m0 = gam(nspawners0 ~ s(cov1,sp=0.6) + s(cov2,sp=0.6), data=dat)
    tmp = data.frame(model=paste0("gam(", modnames[val[1]], "), gam(", modnames[val[2]], ")"), None=ret(m0, resfun))
    res = rbind(res, tmp)
    # m0 = gam(nspawners0 ~ s(cov1,sp=0.6) + cov2, data=dat)
    # tmp = data.frame(model=paste0("gam(", modnames[val[1]], "), lin(", modnames[val[2]], ")"), None=ret(m0, resfun))
    # res = rbind(res, tmp)
    # m0 = gam(nspawners0 ~ cov1 + s(cov2,sp=0.6), data=dat)
    # nm = 
    # tmp = data.frame(model=paste0("lin(", modnames[val[1]], "), gam(", modnames[val[2]], ")"), None=ret(m0, resfun))
    # res = rbind(res, tmp)
  }
}

for(yr in min(dat$Year):max(dat$Year)){
  bad = yr
  dat2=dat
  dat2$nspawners0[dat$Year%in%bad]=NA
  #dat2$nspawners1[dat$Year%in%(bad+1)]=NA
  m0 = gam(nspawners0 ~ nspawners1, data=dat2)
  tmpres = data.frame(model="base",None=ret(m0, resfun))
  
  for(val in tests){
    if(length(val)==1){
      dat2$cov1=dat[[covnames[val[1]]]]
      m0 = gam(nspawners0 ~ cov1, data=dat2)
      tmp = data.frame(model=paste0("lm(", modnames[val[1]],")"), None=ret(m0, resfun))
      tmpres = rbind(tmpres, tmp)
      m0 = gam(nspawners0 ~ s(cov1, sp=0.6), data=dat2)
      tmp = data.frame(model=paste0("gam(", modnames[val[1]],")"), None=ret(m0, resfun))
      tmpres = rbind(tmpres, tmp)
    }else{
      dat2$cov1=dat[[covnames[val[1]]]]
      dat2$cov2=dat[[covnames[val[2]]]]
      m0 = gam(nspawners0 ~ cov1 + cov2, data=dat2)
      tmp = data.frame(model=paste0("lm(", modnames[val[1]], ", ", covnames[val[2]], ")"), None=ret(m0, resfun))
      tmpres = rbind(tmpres, tmp)
      m0 = gam(nspawners0 ~ s(cov1,sp=0.6) + s(cov2,sp=0.6), data=dat2)
      tmp = data.frame(model=paste0("gam(", modnames[val[1]], ", ", covnames[val[2]],")"), None=ret(m0, resfun))
      tmpres = rbind(tmpres, tmp)
      # m0 = gam(nspawners0 ~ s(cov1,sp=0.6) + cov2, data=dat2)
      # tmp = data.frame(model=paste0("gam(", modnames[val[1]], "), lin(", modnames[val[2]], ")"), None=ret(m0, resfun))
      # tmpres = rbind(tmpres, tmp)
      # m0 = gam(nspawners0 ~ cov1 + s(cov2,sp=0.6), data=dat2)
      # tmp = data.frame(model=paste0("lin(", modnames[val[1]], "), gam(", modnames[val[2]], ")"), None=ret(m0, resfun))
      # tmpres = rbind(tmpres, tmp)
    }
  }
  colnames(tmpres)=c("model", yr)
  res=cbind(res,tmpres[,2,drop=FALSE])
}
return(res)
}
```

```{r appD-nspawners-aic, echo=FALSE,fig.cap="Figure 6D. Delta AIC for the Oct-Mar landings base models with one year deleted. The deleted year is shown on the x-axis.", fig.width=8,fig.height=figh,message=FALSE,warning=FALSE}
res <- nspawnerinf(resfun="aicc")
res <- res[res$model%in%modelset,]
baseres=matrix(1,nrow(res),1)%*%matrix(as.numeric(res[1,2:ncol(res)]),nrow=1)
delaic=res[,2:ncol(res)]-baseres
rownames(delaic)=res$model

minrow <- apply(res[,2:ncol(res)],2,function(x){which(x==min(x))})
baseres=matrix(1,nrow(res),1)%*%matrix(as.numeric(res[cbind(minrow,2:ncol(res))]),nrow=1)
delaic2=res[,2:ncol(res)]-baseres
rownames(delaic2)=res$model

library(tidyverse)
df <- gather(cbind(model=res$model, delaic2), year, aic, 2:ncol(delaic2))
df$DelAICc <- cut(df$aic, c(-0.001, .5, 2, 4, 100))
levels(df$DelAICc) <- c("Best (0-0.5)", "Competitive (< 2)", "Uncompetitive (2-4)", "Poor (> 4)")

p <- ggplot(df, aes(year, model)) +
  geom_tile(aes(fill = DelAICc), colour = "grey50")
p + theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1), aspect.ratio = aspr) + scale_fill_manual(values=Palette4)
```

```{r appd-nspawners-loo, echo=FALSE,fig.cap="Figure 7D. Leave-one-out predictive performance for the Oct-Mar landings base models.", fig.width=8,fig.height=figh,message=FALSE,warning=FALSE}
# res2 <- spawnerinf(resfun="loo")
# res <- nspawnerinf(resfun="loo")
# save(res, res2, file="basemodsloo.RData")
load("basemodsloo.RData")
vals=res.all
vals <- vals[vals$model%in%modelset,]
#baseres=matrix(1,nrow(vals),1)%*%matrix(as.numeric(vals[cbind(12,2:ncol(vals))]),nrow=1)
minrow <- apply(vals[,2:ncol(vals)],2,function(x){which(x==min(x))})
baseres=matrix(1,nrow(vals),1)%*%matrix(as.numeric(vals[cbind(minrow,2:ncol(vals))]),nrow=1)
tmp=vals[,2:ncol(vals)]/baseres
rownames(tmp)=vals$model

library(tidyverse)
df <- gather(cbind(model=vals$model, tmp), year, lev, 2:ncol(tmp))
df$DelLOO <- cut(df$lev, c(-.01,0.01,.02,.5, 1))
df$DelLOO <- cut(df$lev, c(.999,1.01,1.05,1.10,1.2,3))
levels(df$DelLOO) <- c("Best (< 1%)", "Similar (1-2%)", "Worse (5-10%)", "Much worse (10-20%)", "Worst (>20%)")

p <- ggplot(df, aes(year, model)) +
  geom_tile(aes(fill = DelLOO), colour = "grey50")
p + theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1), aspect.ratio = aspr) + scale_fill_manual(values=c(Palette4,"red"))
```



```{r appd-nspawners-aic2, echo=FALSE,fig.cap=paste0("Figure 8D. Delta AIC for the Oct-Mar landings base models with ", paste(rmyr, collapse=" and "), " and one additional year deleted. Deleted year is shown on the x-axis."), fig.width=8,fig.height=figh,message=FALSE,warning=FALSE}
rmyr <- 1994:1995
res <- nspawnerinf(rmyr, resfun="aicc")
res <- res[res$model%in%modelset,]

minrow <- apply(res[,2:ncol(res)],2,function(x){which(x==min(x))})
baseres=matrix(1,nrow(res),1)%*%matrix(as.numeric(res[cbind(minrow,2:ncol(res))]),nrow=1)
delaic2=res[,2:ncol(res)]-baseres
rownames(delaic2)=res$model
delaic2=delaic2[,!(colnames(delaic2)%in%rmyr)]

library(tidyverse)
df <- gather(cbind(model=res$model, delaic2), year, aic, 2:ncol(delaic2))
df$DelAIC <- cut(df$aic, c(-0.001, .5, 2, 4, 30))
levels(df$DelAIC) <- c("Best (0-0.5)", "Competitive (< 2)", "Uncompetitive (2-4)", "Poor (> 4)")

p <- ggplot(df, aes(year, model)) +
  geom_tile(aes(fill = DelAIC), colour = "grey50")
p + theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1), aspect.ratio = aspr) + scale_fill_manual(values=Palette4)
```

```{r appd-nspawners-loo-9495, echo=FALSE,fig.cap=paste0("Figure 9D. Leave-one-out predictive performance for the Oct-Sep landings base models with ", paste(rmyr, collapse=" and "), " and one additional year deleted. See Figure 7D for details on the figure."), fig.width=8, fig.height=figh, message=FALSE, warning=FALSE}
# res2 <- spawnerinf(resfun="loo")
# res <- nspawnerinf(resfun="loo")
# save(res, res2, file="basemodsloo.RData")
load("basemodsloo.RData")
vals=res.86879495
vals <- vals[vals$model%in%modelset,]
baseres=matrix(1,nrow(vals),1)%*%matrix(as.numeric(vals[cbind(6,2:ncol(vals))]),nrow=1)
minrow <- apply(vals[,2:ncol(vals)],2,function(x){which(x==min(x))})
baseres=matrix(1,nrow(vals),1)%*%matrix(as.numeric(vals[cbind(minrow,2:ncol(vals))]),nrow=1)
tmp=vals[,2:ncol(vals)]/baseres
rownames(tmp)=vals$model
tmp=tmp[,!(colnames(tmp)%in%rmyr)]


library(tidyverse)
tmp <- cbind(model=vals$model, tmp)
df <- gather(tmp, year, lev, 2:ncol(tmp))
#df$DelLOO <- cut(df$lev, c(-.01,0.01,.02,.5, 1))
df$DelLOO <- cut(df$lev, c(.999,1.01,1.05,1.10,1.2,3))
levels(df$DelLOO) <- c("Best (< 1%)", "Similar (1-2%)", "Worse (5-10%)", "Much worse (10-20%)", "Worst (>20%)")
p <- ggplot(df, aes(year, model)) +
  geom_tile(aes(fill = DelLOO), colour = "grey50")
p + theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1), aspect.ratio = aspr) + scale_fill_manual(values=c(Palette4,"red"))
```


```{r appd-nspawners-r2, echo=FALSE,fig.cap=paste0("Figure 10D. R-squared for the Oct-Mar landings base models. Deleted year is shown on the x-axis."), fig.width=8,fig.height=figh,message=FALSE,warning=FALSE}
res <- nspawnerinf(resfun="r2")
res <- res[res$model%in%modelset,]
#res=res[,!(colnames(res)%in%rmyr)]

library(tidyverse)
df <- gather(res, year, lev, 2:ncol(res))
df$r2 <- cut(df$lev, c(0, .3, .5, .6, .7))

p <- ggplot(df, aes(year, model)) +
  geom_tile(aes(fill = r2), colour = "grey50")
p + theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1), aspect.ratio = aspr) + scale_fill_manual(values=Palette4)
```


```{r, results="asis", echo=FALSE}
cat("\\clearpage")
```
