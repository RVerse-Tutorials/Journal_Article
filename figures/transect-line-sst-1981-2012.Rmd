---
title: "Creating a plot of SST along a transect line"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, results="hide", message=FALSE, fig.align="center")
```

The goal is to make a plot of SST along a transect line.  The motivation behind this is to show the spatio-temporal pattern of the SST fronts off the coast of Kochi.

## Set up the transect

First we will set up our transect with points (lat/lon) every 10km on this line. Here is the transect line drawn on top of the bathymetry off the west coast. 

```{r}
# This will use the **data.table**, **geotools** and **geosphere** 
# packages to create equispaced points between two lat/lon points.
library(data.table)
df <- data.frame(
  Latitude=c(9.9413972, 9.2),
  Longitude=c(76.2, 74)
  )
data.table::setDT(df)

dist.between = 10000 #in meters so 10km

library(geotools)
library(geosphere)    # for distHaversine
get.dist <- function(lon, lat) 
  geosphere::distHaversine(tail(cbind(lon,lat),-1), head(cbind(lon,lat),-1))
# The := function is in data.table
df[,dist:=c(0,cumsum(get.dist(Longitude,Latitude)))]

interp.dist <- function(var,dist) approx(dist,var,xout=seq(min(dist),max(dist),by=dist.between))$y
transect <- data.table::setDT(df)[,lapply(.SD,interp.dist,dist=dist), 
                    .SDcols=c("Latitude","Longitude","dist")]
```

```{r}
# We use the **marmap** package to download bathymetry data and plot.
library(marmap)
library(ggplot2)
xlims <- c(73,80)
ylims <- c(6,15)
bathydata<- getNOAA.bathy(xlims[1], xlims[2], ylims[1], ylims[2])

autoplot(bathydata, geom=c("r", "c")) + 
  scale_fill_etopo() +
  ylim(7,13) +
  xlim(73,79)+
  geom_point(aes(x=Longitude, y=Latitude), data=transect, alpha=1)
```

## Download SST along the transect

We will use the SST, Pathfinder Ver 5.2 (L3C), Day, Global, 0.0417Â°, 1981-2012, Science Quality (Monthly Composite). 0.0417 degrees is 4.63km approx.  This is the 'erdPH2sstdmday' dataset on the ERDDAP server. 

```{r eval=FALSE}
### Install the rerddap packages if needed
require(devtools)
devtools::install_github("ropensci/rerddap")
devtools::install_github("rmendels/rerddapXtracto")
```

```{r}
# Load the packages.
require(rerddap)
require(rerddapXtracto)
```

```{r}
# For convenience, make shorter names for the latitude and longitude data.
xcoord <- transect$Longitude
ycoord <- transect$Latitude
alldata <- data.frame(transect, time=tcoord)
alldata$km <- alldata$dist/1000
```

I define the search box in the x (lon) and y (lat) directions as 0.1, in units of degrees. This is approx 11km. The distance between our transect points is 10km, so this is slight overlap. 

```{r}
xlen <- 0.1  #11 km so approx 22km
ylen <- 0.3
```

## Create colorbars for 1981 to 2012

First set the dates to use. 

```{r}
thedate <- seq(as.Date("1981-01-15"), as.Date("2012-12-16"), by="1 month")
```

We want to get the SST data for the transect at each date.  We will store this in a matrix.

```{r echo=FALSE}
# downloading the Chl data takes a long time so I ran and saved the matrix to a file.
load("meanmat1981-2012-ylen-p3.RData")
```

```{r eval=FALSE}
dataset <- 'erdPH2sstdmday'
dataInfo <- rerddap::info(dataset)
parameter <-'sea_surface_temperature' 
meanmat <- matrix(NA, length(xcoord), length(thedate))
colnames(meanmat) <- as.character(thedate)
for(i in 1:length(thedate)){
  tcoord <- rep(thedate[i], length(xcoord))
  dat <- try(rxtracto(dataInfo, 
                  parameter=parameter, 
                  xcoord=xcoord, ycoord=ycoord,
                  tcoord=tcoord, xlen=xlen, ylen=ylen))
  if(inherits(dat, "try-error")){
    cat(as.character(thedate[i]), " did not download.\n")
    next
  }
  if(month(as.Date(dat$`satellite date`))[1]!=month(thedate[i])){
    cat(as.character(thedate[i]), " missing data for this month.\n")
    next
  }
  names(dat)[names(dat)=="mean sea_surface_temperature"] <- "mean"
  meanmat[,i] <- dat$mean
  cat(dat$`satellite date`[1], "\n")
  if(i %% 12) save(meanmat, file="meanmat1981-2012-ylen-p3.RData")
}
save(meanmat, file="meanmat1981-2012-ylen-p3.RData")
```

Create a matrix like `meanmat` but with color for each value in `meanmat`.

```{r colormap}
cuts <- 50
my.colors <- colorRampPalette(c("dark blue", "light blue", "orange", "red"))
sstcuts <- as.numeric(cut(as.vector(meanmat),breaks = cuts))

# take those levels and associate with the colorpalette
cols <- my.colors(cuts)[sstcuts]

# reassemble into a matrix like meammat
colmat <- matrix(cols, length(xcoord), length(thedate))
```

Now plot strips for each 1-month window. We will set the margin to leave some room for a colorbar. We will add a colorbar at the bottom using the `set.colorbar()` function in the **oceanmap** package. We need to fiddle a little with the `cby` value to get it in the right place.


```{r fig.height=4, fig.width=7}
par(mar=c(8,5,2,2))
wid=8
xaxs <- c(thedate, seq(max(thedate),by="1 month", length=2)[2])-30
n <- length(xaxs)
plot(xaxs, rep(0,n), 
     ylim=c(0,max(alldata$km)), type= "n", xlab = "", ylab = "Distance from coast (km)")
for(j in 1:length(thedate)){
  for(i in 1:dim(alldata)[1]){
  rect(xaxs[j], alldata$km[i], xaxs[j+1], alldata$km[i+1], col = colmat[i,j],
       border=NA) 
  }
}

colb <- my.colors(cuts) # our custom colors
# this bit of code gets the break points
tmp<-levels(cut(as.vector(meanmat),breaks = cuts))
tmp<-sapply(strsplit(tmp, "\\(|,|]"), function(x) as.numeric(x[-1]))
zlims<-tmp[1,]
oceanmap::set.colorbar(
  cbx=c(as.numeric(xaxs[1]), as.numeric(xaxs[n])), 
  cby=c(-100, -130), 
  pal=colb,
  zlim=zlims)
mtext("SST (deg C)", side=1, line=5)
title(paste("SST off the coast in", year(thedate)[1]))
```



Create a matrix like `meanmat` but with color for each value in `meanmat`.

```{r colormap}
library(stringr)
summonsoon <- sapply(colnames(meanmat), function(x){any(str_detect(x, c("-07-","-08-","-09-")))})
tmpm <- meanmat[,summonsoon]
tmpcolmat <- colmat[,summonsoon]
```

Now plot strips for each 1-month window. We will set the margin to leave some room for a colorbar. We will add a colorbar at the bottom using the `set.colorbar()` function in the **oceanmap** package. We need to fiddle a little with the `cby` value to get it in the right place.


```{r fig.height=4, fig.width=7}
par(mar=c(8,5,2,2))
wid=8
xaxs <- as.Date(colnames(tmpm))
xaxs <- c(xaxs, seq(max(xaxs),by="1 month", length=2)[2])
n <- length(xaxs)
xaxs2 <- 1:n
plot(xaxs2, rep(0,n), 
     ylim=c(0,max(alldata$km)), type= "n", xlab = "", ylab = "Distance from coast (km)",
     xaxt="n")
for(j in 1:(length(xaxs)-1)){
  for(i in 1:dim(alldata)[1]){
  #rect(xaxs[j], alldata$km[i], seq(xaxs[j],by="1 month", length=2)[2], alldata$km[i+1], col = colmat[i,j], border=NA) 
  rect(xaxs2[j], alldata$km[i], xaxs2[j+1], alldata$km[i+1], col = tmpcolmat[i,j],
       border=NA) 
  }
}
for(j in 1:(length(xaxs)-1)){
if(month(xaxs[j])==(max(month(xaxs))-1)) abline(v=xaxs2[j+1])
}

colb <- my.colors(cuts) # our custom colors
# this bit of code gets the break points
tmp<-levels(cut(as.vector(meanmat),breaks = cuts))
tmp<-sapply(strsplit(tmp, "\\(|,|]"), function(x) as.numeric(x[-1]))
zlims<-tmp[1,]
oceanmap::set.colorbar(
  cbx=c(as.numeric(xaxs2[1]), as.numeric(xaxs2[n])), 
  cby=c(-100, -130), 
  pal=colb,
  zlim=zlims)
mtext("SST (deg C)", side=1, line=5)
mons <- month.abb[unique(month(as.Date(colnames(tmpm))))]
title(paste("SST off the coast in", paste(mons, collapse=", ")))
axis(side=1, at=seq(3,length(xaxs),3)-0.5, labels=unique(year(xaxs)), las=2)
```

```{r colormap}
library(stringr)
summonsoon <- sapply(colnames(meanmat), function(x){any(str_detect(x, c("-01-","-02-","-03-")))})
tmpm <- meanmat[,summonsoon]
tmpcolmat <- colmat[,summonsoon]
```

Now plot strips for each 1-month window. We will set the margin to leave some room for a colorbar. We will add a colorbar at the bottom using the `set.colorbar()` function in the **oceanmap** package. We need to fiddle a little with the `cby` value to get it in the right place.


```{r fig.height=4, fig.width=7}
par(mar=c(8,5,2,2))
wid=8
xaxs <- as.Date(colnames(tmpm))
xaxs <- c(xaxs, seq(max(xaxs),by="1 month", length=2)[2])
n <- length(xaxs)
xaxs2 <- 1:n
plot(xaxs2, rep(0,n), 
     ylim=c(0,max(alldata$km)), type= "n", xlab = "", ylab = "Distance from coast (km)",
     xaxt="n")
for(j in 1:(length(xaxs)-1)){
  for(i in 1:dim(alldata)[1]){
  #rect(xaxs[j], alldata$km[i], seq(xaxs[j],by="1 month", length=2)[2], alldata$km[i+1], col = colmat[i,j], border=NA) 
  rect(xaxs2[j], alldata$km[i], xaxs2[j+1], alldata$km[i+1], col = tmpcolmat[i,j],
       border=NA) 
  }
}
for(j in 1:(length(xaxs)-1)){
if(month(xaxs[j])==(max(month(xaxs))-1)) abline(v=xaxs2[j+1])
}

colb <- my.colors(cuts) # our custom colors
# this bit of code gets the break points
tmp<-levels(cut(as.vector(meanmat),breaks = cuts))
tmp<-sapply(strsplit(tmp, "\\(|,|]"), function(x) as.numeric(x[-1]))
zlims<-tmp[1,]
oceanmap::set.colorbar(
  cbx=c(as.numeric(xaxs2[1]), as.numeric(xaxs2[n])), 
  cby=c(-100, -130), 
  pal=colb,
  zlim=zlims)
mtext("SST (deg C)", side=1, line=5)
mons <- month.abb[unique(month(as.Date(colnames(tmpm))))]
title(paste("SST off the coast in", paste(mons, collapse=", ")))
axis(side=1, at=seq(3,length(xaxs),3), labels=unique(year(xaxs)), las=2)
```

```{r colormap}
library(stringr)
summonsoon <- sapply(colnames(meanmat), function(x){any(str_detect(x, c("-06-","-07-","-08-")))})
tmpm <- meanmat[,summonsoon]
tmpcolmat <- colmat[,summonsoon]
```

Now plot strips for each 1-month window. We will set the margin to leave some room for a colorbar. We will add a colorbar at the bottom using the `set.colorbar()` function in the **oceanmap** package. We need to fiddle a little with the `cby` value to get it in the right place.


```{r fig.height=4, fig.width=7}
par(mar=c(8,5,2,2))
wid=8
xaxs <- as.Date(colnames(tmpm))
xaxs <- c(xaxs, seq(max(xaxs),by="1 month", length=2)[2])
n <- length(xaxs)
xaxs2 <- 1:n
plot(xaxs2, rep(0,n), 
     ylim=c(0,max(alldata$km)), type= "n", xlab = "", ylab = "Distance from coast (km)",
     xaxt="n")
for(j in 1:(length(xaxs)-1)){
  for(i in 1:dim(alldata)[1]){
  #rect(xaxs[j], alldata$km[i], seq(xaxs[j],by="1 month", length=2)[2], alldata$km[i+1], col = colmat[i,j], border=NA) 
  rect(xaxs2[j], alldata$km[i], xaxs2[j+1], alldata$km[i+1], col = tmpcolmat[i,j],
       border=NA) 
  }
}
for(j in 1:(length(xaxs)-1)){
if(month(xaxs[j])==(max(month(xaxs))-1)) abline(v=xaxs2[j+1])
}

colb <- my.colors(cuts) # our custom colors
# this bit of code gets the break points
tmp<-levels(cut(as.vector(meanmat),breaks = cuts))
tmp<-sapply(strsplit(tmp, "\\(|,|]"), function(x) as.numeric(x[-1]))
zlims<-tmp[1,]
oceanmap::set.colorbar(
  cbx=c(as.numeric(xaxs2[1]), as.numeric(xaxs2[n])), 
  cby=c(-100, -130), 
  pal=colb,
  zlim=zlims)
mtext("SST (deg C)", side=1, line=5)
mons <- month.abb[unique(month(as.Date(colnames(tmpm))))]
title(paste("SST off the coast in", paste(mons, collapse=", ")))
axis(side=1, at=seq(3,length(xaxs),3), labels=unique(year(xaxs)), las=2)
```


```{r colormap}
library(stringr)
summonsoon <- sapply(colnames(meanmat), function(x){any(str_detect(x, c("-09-","-10-","-11-","-12-")))})
tmpm <- meanmat[,summonsoon]
tmpcolmat <- colmat[,summonsoon]
```

Now plot strips for each 1-month window. We will set the margin to leave some room for a colorbar. We will add a colorbar at the bottom using the `set.colorbar()` function in the **oceanmap** package. We need to fiddle a little with the `cby` value to get it in the right place.


```{r fig.height=4, fig.width=7}
par(mar=c(8,5,2,2))
wid=8
xaxs <- as.Date(colnames(tmpm))
xaxs <- c(xaxs, seq(max(xaxs),by="1 month", length=2)[2])
n <- length(xaxs)
xaxs2 <- 1:n
plot(xaxs2, rep(0,n), 
     ylim=c(0,max(alldata$km)), type= "n", xlab = "", ylab = "Distance from coast (km)",
     xaxt="n")
for(j in 1:(length(xaxs)-1)){
  for(i in 1:dim(alldata)[1]){
  #rect(xaxs[j], alldata$km[i], seq(xaxs[j],by="1 month", length=2)[2], alldata$km[i+1], col = colmat[i,j], border=NA) 
  rect(xaxs2[j], alldata$km[i], xaxs2[j+1], alldata$km[i+1], col = tmpcolmat[i,j],
       border=NA) 
  }
}
for(j in 1:(length(xaxs)-1)){
if(month(xaxs[j])==(max(month(xaxs))-1)) abline(v=xaxs2[j+2])
}

colb <- my.colors(cuts) # our custom colors
# this bit of code gets the break points
tmp<-levels(cut(as.vector(meanmat),breaks = cuts))
tmp<-sapply(strsplit(tmp, "\\(|,|]"), function(x) as.numeric(x[-1]))
zlims<-tmp[1,]
oceanmap::set.colorbar(
  cbx=c(as.numeric(xaxs2[1]), as.numeric(xaxs2[n])), 
  cby=c(-100, -130), 
  pal=colb,
  zlim=zlims)
mtext("SST (deg C)", side=1, line=5)
mons <- month.abb[unique(month(as.Date(colnames(tmpm))))]
title(paste("SST off the coast in", paste(mons, collapse=", ")))
axis(side=1, at=seq(3,length(xaxs)+4,4), labels=unique(year(xaxs)), las=2)
```

```{r}
breaks <- seq(1,26,5)
meanmat50 <- matrix(NA,5,dim(meanmat)[2])
colnames(meanmat50) <- colnames(meanmat)
rownames(meanmat50) <- seq(50,250,50)
for(i in 1:5){
  meanmat50[i,] <- apply(meanmat[breaks[i]:breaks[i+1],],2,mean,na.rm=TRUE)
}
mons <- month(as.Date(colnames(meanmat50)))
yrs <- year(as.Date(colnames(meanmat50)))

cuts <- 50
my.colors <- colorRampPalette(c("dark blue", "light blue", "orange", "red"))
sstcuts <- as.numeric(cut(as.vector(meanmat50),breaks = cuts))

# take those levels and associate with the colorpalette
cols <- my.colors(cuts)[sstcuts]

# reassemble into a matrix like meammat
colmat50 <- matrix(cols, dim(meanmat50)[1], dim(meanmat50)[2])

```


```{r colormap}
library(stringr)
summonsoon <- sapply(colnames(meanmat50), function(x){any(str_detect(x, c("-07-","-08-")))})
tmpm <- meanmat50[,summonsoon]
tmpcolmat <- colmat50[,summonsoon]
```

Now plot strips for each 1-month window. We will set the margin to leave some room for a colorbar. We will add a colorbar at the bottom using the `set.colorbar()` function in the **oceanmap** package. We need to fiddle a little with the `cby` value to get it in the right place.


```{r fig.height=4, fig.width=7}
par(mar=c(8,5,2,2))
wid=8
xaxs <- as.Date(colnames(tmpm))
xaxs <- c(xaxs, seq(max(xaxs),by="1 month", length=2)[2])
yaxs <- as.numeric(rownames(meanmat50))-50
yaxs <- c(yaxs, max(yaxs)+50)
n <- length(xaxs)
xaxs2 <- 1:n
plot(xaxs2, rep(0,n), 
     ylim=c(0,max(yaxs)), type= "n", xlab = "", ylab = "Distance from coast (km)",
     xaxt="n")
for(j in 1:(length(xaxs)-1)){
  for(i in 1:dim(meanmat50)[1]){
  rect(xaxs2[j], yaxs[i], xaxs2[j+1], yaxs[i+1], col = tmpcolmat[i,j],
       border=NA) 
  }
}
for(j in 1:(length(xaxs)-1)){
if(month(xaxs[j])==(max(month(xaxs))-1)) abline(v=xaxs2[j+1])
}

colb <- my.colors(cuts) # our custom colors
# this bit of code gets the break points
tmp<-levels(cut(as.vector(meanmat50),breaks = cuts))
tmp<-sapply(strsplit(tmp, "\\(|,|]"), function(x) as.numeric(x[-1]))
zlims<-tmp[1,]
oceanmap::set.colorbar(
  cbx=c(as.numeric(xaxs2[1]), as.numeric(xaxs2[n])), 
  cby=c(-100, -130), 
  pal=colb,
  zlim=zlims)
mtext("SST (deg C)", side=1, line=5)
mons <- month.abb[unique(month(as.Date(colnames(tmpm))))]
title(paste("SST off the coast in", paste(mons, collapse=", ")))
axis(side=1, at=seq(3,length(xaxs),2)-0.5, labels=unique(year(xaxs)), las=2)
```


```{r colormap}
library(stringr)
summonsoon <- sapply(colnames(meanmat50), function(x){any(str_detect(x, c("-05-","-06-")))})
tmpm <- meanmat50[,summonsoon]
tmpcolmat <- colmat50[,summonsoon]
```

Now plot strips for each 1-month window. We will set the margin to leave some room for a colorbar. We will add a colorbar at the bottom using the `set.colorbar()` function in the **oceanmap** package. We need to fiddle a little with the `cby` value to get it in the right place.


```{r fig.height=4, fig.width=7}
par(mar=c(8,5,2,2))
wid=8
xaxs <- as.Date(colnames(tmpm))
xaxs <- c(xaxs, seq(max(xaxs),by="1 month", length=2)[2])
yaxs <- as.numeric(rownames(meanmat50))-50
yaxs <- c(yaxs, max(yaxs)+50)
n <- length(xaxs)
xaxs2 <- 1:n
plot(xaxs2, rep(0,n), 
     ylim=c(0,max(yaxs)), type= "n", xlab = "", ylab = "Distance from coast (km)",
     xaxt="n")
for(j in 1:(length(xaxs)-1)){
  for(i in 1:dim(meanmat50)[1]){
  rect(xaxs2[j], yaxs[i], xaxs2[j+1], yaxs[i+1], col = tmpcolmat[i,j],
       border=NA) 
  }
}
for(j in 1:(length(xaxs)-1)){
if(month(xaxs[j])==(max(month(xaxs))-1)) abline(v=xaxs2[j+1])
}

colb <- my.colors(cuts) # our custom colors
# this bit of code gets the break points
tmp<-levels(cut(as.vector(meanmat50),breaks = cuts))
tmp<-sapply(strsplit(tmp, "\\(|,|]"), function(x) as.numeric(x[-1]))
zlims<-tmp[1,]
oceanmap::set.colorbar(
  cbx=c(as.numeric(xaxs2[1]), as.numeric(xaxs2[n])), 
  cby=c(-100, -130), 
  pal=colb,
  zlim=zlims)
mtext("SST (deg C)", side=1, line=5)
mons <- month.abb[unique(month(as.Date(colnames(tmpm))))]
title(paste("SST off the coast in", paste(mons, collapse=", ")))
axis(side=1, at=seq(3,length(xaxs),2)-0.5, labels=unique(year(xaxs)), las=2)
```